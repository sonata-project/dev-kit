branches:
  only:
    - master
    - deploy

language: php

php: 7.1

sudo: false

cache:
  directories:
    - $HOME/.composer

env:
  global:
    - PATH="$HOME/.local/bin:$PATH"
    - DEPLOY_SERVER="dev-kit.sonata-project.org"
    - DEPLOY_USER="dev.kit"
    - IMAGE_NAME="dev_kit_${TRAVIS_BUILD_ID}"

before_install:
  - echo ${SSH_PRIVATE_KEY}
  - phpenv config-rm xdebug.ini
  - mkdir --parents ~/.local/bin
  - wget http://cs.sensiolabs.org/download/php-cs-fixer-v2.phar --output-document=php-cs-fixer.phar

install:
  - |
      composer global show hirak/prestissimo --quiet ||
      travis_retry composer global require hirak/prestissimo --prefer-dist --no-interaction --no-progress
  - composer update --prefer-dist --no-interaction --no-progress

script:
  - php php-cs-fixer.phar fix --verbose --dry-run --diff
  - touch .env
  - ./dev-kit dispatch

deploy:
  provider: script
  script: bash deploy.sh
  on:
    branch: deploy
