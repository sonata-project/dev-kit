# DO NOT EDIT THIS FILE!
#
# It's auto-generated by sonata-project/dev-kit package.

name: Quality assurance

on:
  push:
    branches:
{% for branch in project.branchesReverse %}
      - {{ branch.name }}
{% endfor %}
  pull_request:

jobs:
{% if project.usesPHPStan %}
  phpstan:
    name: PHPStan

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

{# Remove when removing 3.x for the managed branches of block-bundle #}
{% if project.repository.name == 'SonataBlockBundle' and branch.name == '3.x' %}
      - name: Set COMPOSER_ROOT_VERSION environment variable
        uses: ergebnis/composer-root-version-action@0.2.0
        with:
          branch: master

{% endif %}
      - name: PHPStan
        uses: docker://oskarstark/phpstan-ga
        env:
          REQUIRE_DEV: true
{% if project.repository.name in ['SonataDoctrineMongoDBAdminBundle', 'sandbox'] %}
          CHECK_PLATFORM_REQUIREMENTS: false
{% endif %}
        with:
          args: analyse
{% endif %}
{% if project.usesPsalm %}
  psalm:
    name: Psalm

    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-version:
          - "7.4"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

{# Remove when removing 3.x for the managed branches of block-bundle #}
{% if project.repository.name == 'SonataBlockBundle' and branch.name == '3.x' %}
      - name: Set COMPOSER_ROOT_VERSION environment variable
        uses: ergebnis/composer-root-version-action@0.2.0
        with:
          branch: master

{% endif %}
      - name: Install PHP with extensions
        uses: shivammathur/setup-php@v2
        with:
            {% verbatim %}php-version: ${{ matrix.php-version }}{% endverbatim %}
            coverage: none
{% if branch.hasService('mongodb') %}
            tools: composer:v{{ project.composerVersion }}, pecl
            extensions: mongodb
{% else %}
            tools: composer:v{{ project.composerVersion }}
{% endif %}
      - name: Cache dependencies installed with composer
        uses: actions/cache@v2
        with:
          path: ~/.composer/cache
          {% verbatim %}key: ${{ matrix.php-version }}-composer-{% endverbatim %}
          restore-keys: |
            {% verbatim %}${{ matrix.php-version }}-composer-{% endverbatim %}

      - name: Install dependencies with composer
        run: "composer install --no-interaction --no-progress --no-suggest"

      - name: Run a static analysis with Psalm
        run: "vendor/bin/psalm --show-info=false --stats --output-format=github --threads=$(nproc) --shepherd"
{% endif %}
